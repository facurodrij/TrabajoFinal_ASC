{% extends "extends/admin/base.html" %}
{% load static %}

{% block head_css %}
    <style>
        .modal-backdrop-carnet {
            opacity: 0.9 !important;
            z-index: -1;
        }
    </style>
{% endblock head_css %}

{% block breadcrumbs %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin-socio-listado' %}">Socios</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        {% if socio.is_deleted %}
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">Socio dado de baja</h4>
                <p>El socio {{ socio }} se encuentra dado de baja. Para editarlo debe restaurarlo presionando el botón
                    de restaurar.</p>
                <hr>
                <form action="{% url 'admin-socio-restaurar' socio.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-rotate-left"></i>
                        Restaurar
                    </button>
                </form>
            </div>
        {% else %}
            <div class="row">
                <div class="col-lg-4 col-md-12">
                    <div class="d-flex flex-column align-items-center mb-3">
                        <img class="rounded-circle mt-3"
                             src="{{ socio.persona.get_imagen }}" alt="" style="max-width: 200px; max-height: 200px">
                    </div>
                    <div class="d-flex flex-column align-items-center mb-3">
                        <a id="btn-print" href="">
                            <div id="socio_carnet" class="card" style="width: 8.56cm; height: 5.398cm; background: rgb(254,255,0);
background: linear-gradient(0deg, rgba(254,255,0,1) 0%, rgba(9,15,121,1) 75%, rgba(9,39,121,1) 100%);">
                                <div class="card-body">
                                    <div class="row" style="height: 40%">
                                        <h4 style="color: yellow">Club Atlético Bartolomé Mitre</h4>
                                        <h5 style="color: white">
                                            <strong>{{ socio.persona.apellido }}, {{ socio.persona.nombre }}</strong>
                                        </h5>
                                    </div>
                                    <div class="row">
                                        <div class="col-3">
                                            <img src="{{ socio.persona.get_imagen }}" alt=""
                                                 style="max-width: 85px; max-height: 85px">
                                        </div>
                                        <div class="col-9 p-0">
                                            <ul style="list-style: none;">
                                                <li style="color: yellow"><strong>Socio N°: {{ socio.pk }}</strong></li>
                                                <li style="color: white">
                                                    <strong>CUIL: {{ socio.persona.cuil_completo }}</strong></li>
                                                <li class="text-right"><img
                                                        src="{{ socio.persona.club.get_imagen }}"
                                                        alt="Logo Club"
                                                        style="max-width: 60px">
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-8 col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h3 class="card-title">{{ title }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <h5>Información Personal</h5>
                                    <ul class="list-group mb-1">
                                        <li class="list-group-item"><b>CUIL: </b>{{ socio.persona.cuil_completo }}</li>
                                        <li class="list-group-item"><b>Nombre
                                            completo: </b>{{ socio.persona.get_full_name }}</li>
                                        <li class="list-group-item"><b>Sexo: </b>{{ socio.persona.sexo }}</li>
                                        <li class="list-group-item"><b>Edad: </b>{{ socio.persona.get_edad }}
                                            ({{ socio.persona.fecha_nacimiento }})
                                        </li>
                                        {% if not socio.persona.es_titular %}
                                            <li class="list-group-item"><b>Persona a cargo: </b>
                                                {{ socio.persona.persona_titular }}<br>
                                            </li>
                                        {% endif %}
                                    </ul>
                                    <a href="{% url 'admin-persona-editar' socio.persona.pk %}"
                                       class="btn btn-sm btn-warning">
                                        <i class="fa-solid fa-edit"></i>
                                    </a>
                                </div>
                                <div class="col">
                                    <h5>Información de Socio</h5>
                                    <ul class="list-group mb-1">
                                        <li class="list-group-item"><b>Categoria: </b>{{ socio.get_categoria }}</li>
                                        <li class="list-group-item"><b>Antigüedad: </b>{{ socio.get_antiguedad }}
                                            ({{ socio.date_created }})
                                        </li>
                                        <li class="list-group-item"><b>Estado de socio: </b>{{ socio.get_estado }}</li>
                                        {% if socio.user %}
                                            <li class="list-group-item"><b>Email: </b>{{ socio.user.email }}</li>
                                            <li class="list-group-item">
                                                <b>Estado de usuario: </b>{{ socio.user.get_estado }}
                                            </li>
                                            <li class="list-group-item">
                                                <b>Fecha de creación de usuario: </b>{{ socio.user.date_joined }}
                                            </li>
                                            <li class="list-group-item">
                                                <b>Último inicio de sesión: </b>
                                                {% if not socio.user.last_login %}
                                                    <span>Aún no ha iniciado sesión</span>
                                                {% else %}
                                                    {{ socio.user.last_login }}
                                                {% endif %}
                                            </li>
                                        {% endif %}
                                    </ul>
                                    <a href="{% url 'admin-socio-editar' socio.pk %}" class="btn btn-sm btn-warning">
                                        <i class="fa-solid fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'admin-socio-listado' %}" class="btn btn-secondary float-right">
                                <i class="fa-solid fa-rotate-left"></i> Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% if socio.get_cantidad_miembros > 1 %}
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary">
                                <h3 class="card-title">Grupo Familiar</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table id="dataTable" class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th scope="col" style="">#</th>
                                        <th scope="col" style="">CUIL</th>
                                        <th scope="col" style="">Nombre completo</th>
                                        <th scope="col" style="">Edad</th>
                                        <th scope="col" style="">Categoría</th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for miembro in grupo_familiar %}
                                        <tr>
                                            <td>{{ miembro.pk }}</td>
                                            <td>{{ miembro.persona.cuil_completo }}</td>
                                            <td>{{ miembro.persona.get_full_name }}</td>
                                            <td>{{ miembro.persona.get_edad }}</td>
                                            <td>{{ miembro.get_categoria }}</td>
                                            {% if not miembro.is_deleted %}
                                                <td>
                                                    <a href="{% url 'admin-socio-detalle' miembro.pk %}"
                                                       class="btn btn-info btn-sm">
                                                        <i class="fa-solid fa-eye"></i>
                                                    </a>
                                                    <a href="{% url 'admin-socio-editar' miembro.pk %}"
                                                       class="btn btn-warning btn-sm">
                                                        <i class="fa-solid fa-edit"></i>
                                                    </a>
                                                    <a href="{% url 'admin-socio-baja' miembro.pk %}"
                                                       class="btn btn-danger btn-sm">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </a>
                                                </td>
                                            {% else %}
                                                <td>
                                                    <a href="{% url 'admin-socio-detalle' miembro.pk %}"
                                                       class="btn btn-info btn-sm">
                                                        <i class="fa-solid fa-eye"></i>
                                                    </a>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <th scope="col" style="">#</th>
                                        <th scope="col" style="">CUIL</th>
                                        <th scope="col" style="">Nombre completo</th>
                                        <th scope="col" style="">Edad</th>
                                        <th scope="col" style="">Categoría</th>
                                        <th></th>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endblock content %}

{% block body_js %}
    {# DataTable #}
    <link rel="stylesheet" type="text/css" href="{% static 'libs/DataTables/datatables.css' %}"/>
    <script type="text/javascript" src="{% static 'libs/DataTables/datatables.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/DataTables/Select-1.5.0/js/dataTables.select.js' %}"></script>
    <script>
        let table = $('#dataTable');

        table.DataTable({
            language: {
                "processing": "Procesando...",
                "lengthMenu": "Mostrar _MENU_ registros",
                "zeroRecords": "No se encontraron resultados",
                "emptyTable": "Ningún dato disponible en esta tabla",
                "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                "search": "Buscar:",
                "infoThousands": ",",
                "loadingRecords": "Cargando...",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "aria": {
                    "sortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sortDescending": ": Activar para ordenar la columna de manera descendente"
                },
                "buttons": {
                    "copy": "Copiar",
                    "colvis": "Visibilidad",
                    "collection": "Colección",
                    "colvisRestore": "Restaurar visibilidad",
                    "copyKeys": "Presione ctrl o u2318 + C para copiar los datos de la tabla al portapapeles del sistema. <br \/> <br \/> Para cancelar, haga clic en este mensaje o presione escape.",
                    "copySuccess": {
                        "1": "Copiada 1 fila al portapapeles",
                        "_": "Copiadas %ds fila al portapapeles"
                    },
                    "copyTitle": "Copiar al portapapeles",
                    "csv": "CSV",
                    "excel": "Excel",
                    "pageLength": {
                        "-1": "Mostrar todas las filas",
                        "_": "Mostrar %d filas"
                    },
                    "pdf": "PDF",
                    "print": "Imprimir",
                    "renameState": "Cambiar nombre",
                    "updateState": "Actualizar",
                    "createState": "Crear Estado",
                    "removeAllStates": "Remover Estados",
                    "removeState": "Remover",
                    "savedStates": "Estados Guardados",
                    "stateRestore": "Estado %d"
                },
                "searchPanes": {
                    "clearMessage": "Borrar todo",
                    "collapse": {
                        "0": '<i class="fa-solid fa-filter"></i> Filtros',
                        "_": '<i class="fa-solid fa-filter"></i> Filtros (%d)'
                    },
                    "count": "{total}",
                    "countFiltered": "{shown} ({total})",
                    "emptyPanes": "No hay suficientes datos para mostrar los filtros",
                    "loadMessage": "Cargando paneles de búsqueda",
                    "title": "Filtros Activos - %d",
                    "showMessage": "Mostrar Todo",
                    "collapseMessage": "Colapsar Todo"
                },
                "select": {
                    "cells": {
                        "1": "1 celda seleccionada",
                        "_": "%d celdas seleccionadas"
                    },
                    "columns": {
                        "1": "1 columna seleccionada",
                        "_": "%d columnas seleccionadas"
                    },
                    "rows": {
                        "1": "1 fila seleccionada",
                        "_": "%d filas seleccionadas"
                    }
                },
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
            },
            dom: 'Bfrtip',
            columnDefs: [ // Quitarle estilos a la ultima columna
                {"orderable": false, "targets": -1}
            ],
            responsive: true,
            order: [[0, 'desc']],
            autoWidth: false,
            buttons: [
                {
                    extend: 'print',
                    text: '<i class="fa-solid fa-print"></i> Imprimir',
                    titleAttr: 'Imprimir',
                    className: 'btn btn-info btn-sm border',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5]
                    }
                },
                {
                    extend: 'colvis',
                    text: '<i class="fa-solid fa-eye"></i> Ver columnas',
                    titleAttr: 'Ver columnas',
                    className: 'btn btn-secondary btn-sm border',
                    columns: ':gt(0)',
                    postfixButtons: ['colvisRestore']
                },
                {
                    extend: 'searchPanes',
                    text: '<i class="fa-solid fa-filter"></i> Filtros',
                    className: 'btn btn-secondary btn-sm border',
                    config: {
                        cascadePanes: true,
                        viewTotal: true,
                        layout: 'columns-3',
                        columns: [1, 2, 3, 4, 5],
                    }
                },
                {
                    extend: 'pageLength',
                    className: 'btn btn-secondary btn-sm border',
                }
            ],
            // La fila que tiene el mismo id igual 2, fondo success
            rowId: 'id',
            rowCallback: function (row, data, index) {
                if (data[0] === '{{ object.pk }}') {
                    $(row).addClass('table-success');
                }
            },
        });
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        $('#btn-print').on('click', function (e) {
            e.preventDefault();
            html2canvas(document.querySelector("#socio_carnet"), {allowTaint: true}).then(canvas => {
                // Abrir una nueva ventana con el canvas
                let win = window.open();
                // Cambiar el fondo de win a negro
                win.document.body.style.backgroundColor = "black";
                win.document.body.appendChild(canvas);
                // Canvas con posición absoluta, top: 50% y left: 50% para centrarlo
                canvas.style.position = "absolute";
                canvas.style.top = "50%";
                canvas.style.left = "50%";
                // Transformar el canvas para centrarlo
                canvas.style.transform = "translate(-50%, -50%)";
            });
        });
    </script>
{% endblock body_js %}
